x-ray-common: &ray-common
  image: ${VLLM_IMAGE}
  container_name: node
  network_mode: host
  shm_size: "10.24g"
  # GPU 요청 (Compose v2에서 지원). 만약 동작 안 하면 주석 처리하고 device_requests 블록을 사용하세요.
  gpus: all
  # device_requests:
  #   - driver: nvidia
  #     count: -1
  #     capabilities: ["gpu"]
  restart: unless-stopped
  volumes:
    - ${HF_HOME}:/root/.cache/huggingface:rw
  environment:
    # 노드/네트워크
    VLLM_HOST_IP: ${VLLM_HOST_IP}
    HEAD_NODE_IP: ${HEAD_NODE_IP}
    MASTER_ADDR: ${HEAD_NODE_IP}
    # 전용 NIC 고정
    MN_IF_NAME: ${MN_IF_NAME}
    UCX_NET_DEVICES: ${MN_IF_NAME}
    NCCL_SOCKET_IFNAME: ${MN_IF_NAME}
    OMPI_MCA_btl_tcp_if_include: ${MN_IF_NAME}
    GLOO_SOCKET_IFNAME: ${MN_IF_NAME}
    TP_SOCKET_IFNAME: ${MN_IF_NAME}
    # Ray 메모리 모니터 주기
    RAY_memory_monitor_refresh_ms: ${RAY_memory_monitor_refresh_ms:-0}
    RAY_NODE_IP_ADDRESS: ${VLLM_HOST_IP}
    RAY_OVERRIDE_RESOLVED_IP: ${VLLM_HOST_IP}
  # 필요 시 권한 이슈가 있으면 다음 줄을 잠깐 켜보세요 (컨테이너 root로 실행)
  # user: "0:0"

services:
  head:
    <<: *ray-common
    # 쉘 없이 ray 바이너리를 직접 엔트리포인트로 호출
    entrypoint: ["ray"]
    command: ["start","--head","--port=6379","--node-ip-address=${VLLM_HOST_IP}","--dashboard-host=0.0.0.0","--block"]
    environment:
      RAY_ADDRESS: auto
      RAY_NODE_IP_ADDRESS: ${VLLM_HOST_IP}
      RAY_OVERRIDE_RESOLVED_IP: ${VLLM_HOST_IP}
    profiles: ["head"]

  worker:
    <<: *ray-common
    entrypoint: ["ray"]
    command: ["start","--address=${HEAD_NODE_IP}:6379","--node-ip-address=${VLLM_HOST_IP}","--block"]
    environment:
      RAY_NODE_IP_ADDRESS: ${VLLM_HOST_IP}
      RAY_OVERRIDE_RESOLVED_IP: ${VLLM_HOST_IP}
    profiles: ["worker"]
