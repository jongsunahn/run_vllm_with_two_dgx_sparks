x-ray-common: &ray-common
  image: ${VLLM_IMAGE}
  container_name: node
  shm_size: "10.24g"
  gpus: all
  restart: unless-stopped
  volumes:
    - ${HF_HOME}:/root/.cache/huggingface:rw
    - ${TIKTOKEN_ENCODINGS_BASE}:/root/harmony_encodings:ro
  # ğŸš¨ network_mode: host ì œê±°
  networks:
    - vllm_net # macvlan ë„¤íŠ¸ì›Œí¬ì— ì—°ê²°
  environment:
    # .env íŒŒì¼ì—ì„œ VLLM_HOST_IPë¥¼ ì½ì–´ì˜´
    RAY_NODE_IP_ADDRESS: ${VLLM_HOST_IP} 
    RAY_OVERRIDE_RESOLVED_IP: ${VLLM_HOST_IP}
    HF_HUB_OFFLINE: "1"
    # ì»¨í…Œì´ë„ˆ ë‚´ì˜ ê°€ìƒ ì¸í„°í˜ì´ìŠ¤ ì´ë¦„(ë³´í†µ eth0)ì„ ì‚¬ìš©
    MN_IF_NAME: eth0
    UCX_NET_DEVICES: eth0
    NCCL_SOCKET_IFNAME: eth0
    OMPI_MCA_btl_tcp_if_include: eth0
    GLOO_SOCKET_IFNAME: eth0
    TP_SOCKET_IFNAME: eth0
    RAY_memory_monitor_refresh_ms: ${RAY_memory_monitor_refresh_ms:-0}
    TIKTOKEN_ENCODINGS_BASE: /root/harmony_encodings
networks:
  vllm_net:
    driver: macvlan
    driver_opts:
      # .env íŒŒì¼ì—ì„œ í˜¸ìŠ¤íŠ¸ì˜ ë¬¼ë¦¬ NIC ì´ë¦„ì„ ì½ì–´ì˜´
      parent: ${MN_IF_NAME} 
    ipam:
      config:
        # .env íŒŒì¼ì—ì„œ ë„¤íŠ¸ì›Œí¬ ì •ë³´ë¥¼ ì½ì–´ì˜´
        - subnet: ${MACVLAN_SUBNET}
          gateway: ${MACVLAN_GATEWAY}

services:
  head:
    <<: *ray-common
    container_name: head-node
    networks:
      vllm_net:
        # .env íŒŒì¼ì—ì„œ ì´ ì»¨í…Œì´ë„ˆì˜ ê³ ìœ  IPë¥¼ í• ë‹¹
        ipv4_address: ${VLLM_HOST_IP} 
    entrypoint: ["ray"]
    command: ["start","--head","--port=6379","--node-ip-address=${VLLM_HOST_IP}","--dashboard-host=0.0.0.0","--block"]
    profiles: ["head"]

  worker:
    <<: *ray-common
    container_name: worker-node
    networks:
      vllm_net:
        # .env íŒŒì¼ì—ì„œ ì´ ì»¨í…Œì´ë„ˆì˜ ê³ ìœ  IPë¥¼ í• ë‹¹
        ipv4_address: ${VLLM_HOST_IP}
    entrypoint: ["ray"]
    # .env íŒŒì¼ì˜ HEAD_NODE_IPë¥¼ ì°¸ì¡°í•˜ì—¬ Headì— ì—°ê²°
    command: ["start","--address=${HEAD_NODE_IP}:6379","--node-ip-address=${VLLM_HOST_IP}","--block"]
    profiles: ["worker"]
